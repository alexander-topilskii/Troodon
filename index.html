<!doctype html>
<html lang="ru">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Troodon: Аренда vs Ипотека — калькулятор выгоды</title>
    <style>
        :root{
            --bg:#0b0d12;--card:#121826;--muted:#9aa4b2;--text:#e8eef7;--line:#22304a;
            --accent:#7aa2ff;--good:#35d07f;--bad:#ff5a6f;--warn:#ffd166;
            --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial, "Apple Color Emoji", "Segoe UI Emoji";
        }
        *{box-sizing:border-box}
        body{margin:0;font-family:var(--sans);background:linear-gradient(180deg,#070910 0%, #0b0d12 55%, #070910 100%);color:var(--text)}
        .wrap{max-width:1100px;margin:0 auto;padding:18px}
        h1{margin:0 0 8px;font-size:20px}
        .sub{color:var(--muted);margin:0 0 18px;font-size:13px;line-height:1.4}
        .grid{display:grid;grid-template-columns:360px 1fr;gap:14px}
        @media (max-width: 920px){.grid{grid-template-columns:1fr}}
        .card{background:rgba(18,24,38,.92);border:1px solid rgba(34,48,74,.9);border-radius:14px;box-shadow:0 10px 40px rgba(0,0,0,.25)}
        .card .hd{padding:14px 14px 0}
        .card .bd{padding:14px}
        .row{display:grid;grid-template-columns:1fr 150px;gap:10px;align-items:center;margin:10px 0}
        .row label{color:var(--muted);font-size:12px}
        input, select{width:100%;padding:10px 10px;border-radius:10px;border:1px solid var(--line);background:#0e1422;color:var(--text);outline:none}
        input:focus,select:focus{border-color:rgba(122,162,255,.9);box-shadow:0 0 0 3px rgba(122,162,255,.15)}
        .hint{color:var(--muted);font-size:12px;line-height:1.45;margin-top:10px}
        .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:999px;border:1px solid var(--line);background:#0e1422;color:var(--muted);font-size:12px}
        .kpi{display:grid;grid-template-columns:1fr 1fr;gap:10px}
        @media (max-width: 520px){.kpi{grid-template-columns:1fr}}
        .k{padding:12px;border-radius:12px;border:1px solid var(--line);background:#0e1422}
        .k .t{color:var(--muted);font-size:12px}
        .k .v{margin-top:6px;font-size:15px;font-family:var(--mono)}
        .ok{color:var(--good)}
        .no{color:var(--bad)}
        .warn{color:var(--warn)}
        table{width:100%;border-collapse:collapse;font-size:12px}
        th,td{padding:10px 8px;border-bottom:1px solid rgba(34,48,74,.7);text-align:right;white-space:nowrap}
        th:first-child, td:first-child{text-align:left}
        th{color:var(--muted);font-weight:600}
        .small{color:var(--muted);font-size:11px}
        .footer{color:var(--muted);font-size:11px;margin-top:10px;line-height:1.45}
        .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
        button{padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:#0e1422;color:var(--text);cursor:pointer}
        button:hover{border-color:rgba(122,162,255,.9)}
        .note{border-left:3px solid rgba(122,162,255,.8);padding:10px 12px;background:rgba(122,162,255,.08);border-radius:12px;color:var(--muted);font-size:12px;line-height:1.45}
        code{font-family:var(--mono);font-size:12px;color:#cfe0ff}
    </style>
</head>
<body>
<div class="wrap">
    <h1>Troodon: Аренда vs Ипотека — когда брать и когда ждать</h1>
    <p class="sub">Модель считает (1) месяц, когда вы впервые можете взять ипотеку (накопления ≥ минимум для взноса), и (2) месяц, когда выгоднее перестать снимать и покупать.
        «Выгода» = <code>аренда до покупки + проценты по ипотеке</code>. Тело кредита и стоимость квартиры считаются вашим активом и не входят в «потери».</p>

    <div class="grid">
        <div class="card">
            <div class="hd"><div class="pill">Вводные параметры</div></div>
            <div class="bd">
                <div class="row">
                    <label>Дата старта расчёта</label>
                    <input id="startDate" type="date" />
                </div>
                <div class="row">
                    <label>Накопления сейчас</label>
                    <input id="s0" type="number" min="0" step="100" value="0" />
                </div>
                <div class="row">
                    <label>Откладываю в месяц</label>
                    <input id="save" type="number" min="0" step="50" value="2000" />
                </div>
                <div class="row">
                    <label>Цена квартиры</label>
                    <input id="price" type="number" min="0" step="1000" value="250000" />
                </div>
                <div class="row">
                    <label>Подорожание квартиры</label>
                    <input id="homeGrow" type="number" min="0" step="0.1" value="1" />
                </div>
                <div class="small" style="margin-top:-6px;margin-bottom:8px">% каждые 6 месяцев (ступенчато, с компаундом)</div>
                <div class="row">
                    <label>Требование взноса</label>
                    <select id="dpPct">
                        <option value="0.1">10%</option>
                        <option value="0.2">20%</option>
                        <option value="0.3" selected>30%</option>
                        <option value="0.4">40%</option>
                        <option value="0.5">50%</option>
                    </select>
                </div>
                <div class="row">
                    <label>Ставка банка (годовых)</label>
                    <input id="apr" type="number" min="0" step="0.01" value="4.5" />
                </div>
                <div class="row">
                    <label>Макс срок ипотеки (лет)</label>
                    <input id="maxYears" type="number" min="1" step="1" value="25" />
                </div>
                <div class="row">
                    <label>Аренда в месяц</label>
                    <input id="rent" type="number" min="0" step="10" value="1000" />
                </div>
                <div class="row">
                    <label>Подорожание аренды</label>
                    <input id="rentGrow" type="number" min="0" step="10" value="100" />
                </div>
                <div class="small" style="margin-top:-6px;margin-bottom:8px">+€ в год (ступенчато: раз в 12 месяцев)</div>

                <div class="note" style="margin-top:12px">
                    <div><b>Ограничение по платёжеспособности</b></div>
                    <div>Чтобы выбор «короче ипотека выгоднее» не уходил в абсурд (1 месяц), модель ограничивает ежемесячный платёж.</div>
                    <div style="margin-top:8px">По умолчанию максимум = <code>аренда + откладываю в месяц</code>, можно изменить вручную.</div>
                </div>

                <div class="row" style="margin-top:12px">
                    <label>Макс платёж/мес (лимит)</label>
                    <input id="payCap" type="number" min="0" step="10" value="0" />
                </div>

                <div class="row">
                    <label>Горизонт моделирования (лет)</label>
                    <input id="horizonYears" type="number" min="1" step="1" value="40" />
                </div>

                <div class="btns">
                    <button id="calcBtn">Посчитать</button>
                    <button id="resetBtn">Сбросить</button>
                </div>

                <div class="hint">
                    Принципы:
                    <ul>
                        <li>Накопления растут линейно: <code>S(t)=S0+save·t</code>.</li>
                        <li>Покупка возможна, когда <code>S(t) ≥ price·dpPct</code>.</li>
                        <li>При покупке вы кладёте на взнос <b>все накопления</b> (до цены): <code>loan = price - min(S(t), price)</code>.</li>
                        <li>Выбирается <b>самый короткий срок</b> ≤ maxYears, при котором платёж ≤ payCap. Если не найден — используется maxYears и пометка «платёж выше лимита».</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="hd"><div class="pill">Результаты</div></div>
            <div class="bd">
                <div class="kpi" id="kpi"></div>
                <div style="margin-top:12px" class="pill">Таблица сценариев (первые 24 месяца после возможности)</div>
                <div style="margin-top:10px;overflow:auto">
                    <table id="tbl">
                        <thead>
                        <tr>
                            <th>Дата покупки</th>
                            <th>Накопления</th>
                            <th>Цена (на дату)</th>
                            <th>Взнос мин</th>
                            <th>Кредит</th>
                            <th>Срок</th>
                            <th>Платёж/мес</th>
                            <th>Проценты</th>
                            <th>Аренда до</th>
                            <th>«Потери»</th>
                            <th>Δ к лучшему</th>
                        </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div class="footer">
                    «Потери» = аренда до покупки + проценты по ипотеке. Если вы хотите учитывать рост цены недвижимости/аренды/доходность инвестирования — это отдельные параметры, их можно добавить.
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const $ = (id) => document.getElementById(id);

    function fmtMoney(x){
        if (!isFinite(x)) return '—';
        const sign = x < 0 ? '-' : '';
        const v = Math.abs(x);
        return sign + v.toLocaleString('en-US', {maximumFractionDigits: 0});
    }
    function fmtPct(x){ return (x*100).toFixed(2) + '%'; }

    function addMonths(d, m){
        const x = new Date(d.getTime());
        const day = x.getDate();
        x.setMonth(x.getMonth() + m);
        // стабилизируем конец месяца
        if (x.getDate() !== day) x.setDate(0);
        return x;
    }
    function fmtMonth(d){
        return d.toLocaleDateString('en-GB', {year:'numeric', month:'long'});
    }

    // PMT: платеж по кредиту (возвращает положительное число)
    function pmt(rate, nper, pv){
        if (nper <= 0) return NaN;
        if (Math.abs(rate) < 1e-12) return -(pv / nper);
        const r = rate;
        const v = Math.pow(1+r, nper);
        return -(pv * r * v) / (v - 1);
    }

    // выбрать срок: самый короткий, который проходит по лимиту платежа
    function chooseTermMonths(loan, rMonth, maxMonths, payCap){
        const out = { months: maxMonths, payment: NaN, ok: true };
        if (loan <= 0){
            out.months = 0; out.payment = 0; out.ok = true;
            return out;
        }
        // если лимита нет или нулевой -> считаем что лимита нет, берём maxMonths
        if (!(payCap > 0)){
            out.months = maxMonths;
            out.payment = pmt(rMonth, maxMonths, -loan);
            out.ok = true;
            return out;
        }

        let best = null;
        for (let m=1; m<=maxMonths; m++){
            const pay = pmt(rMonth, m, -loan);
            if (pay <= payCap){ best = {months:m, payment:pay}; break; }
        }
        if (best){
            out.months = best.months;
            out.payment = best.payment;
            out.ok = true;
        } else {
            // не вписывается даже на максимальном сроке
            out.months = maxMonths;
            out.payment = pmt(rMonth, maxMonths, -loan);
            out.ok = false;
        }
        return out;
    }

    function interestTotal(loan, rMonth, months){
        if (loan <= 0 || months <= 0) return 0;
        const pay = pmt(rMonth, months, -loan);
        return pay*months - loan;
    }

    function calc(){
        const start = $('startDate').value ? new Date($('startDate').value + 'T00:00:00') : new Date();
        const s0 = +$('s0').value || 0;
        const save = +$('save').value || 0;

        const price0 = +$('price').value || 0;
        const homeGrowSemi = (+$('homeGrow').value || 0) / 100; // % каждые 6 месяцев

        const dpPct = +$('dpPct').value || 0;
        const apr = (+$('apr').value || 0) / 100;
        const maxYears = Math.max(1, Math.floor(+$('maxYears').value || 25));

        const rent0 = +$('rent').value || 0;
        const rentGrowYear = +$('rentGrow').value || 0; // +€/год

        const horizonYears = Math.max(1, Math.floor(+$('horizonYears').value || 40));

        function priceAt(tMonths){
            const k = Math.floor(tMonths / 6);
            return price0 * Math.pow(1 + homeGrowSemi, k);
        }

        function dpMinAt(tMonths){
            return priceAt(tMonths) * dpPct;
        }

        function rentAtMonth(m){
            return rent0 + rentGrowYear * Math.floor(m / 12);
        }

        function rentPaidUpTo(tMonths){
            // сумма за месяцы 0..t-1 при росте раз в год
            const t = Math.max(0, Math.floor(tMonths));
            const y = Math.floor(t / 12);
            const rem = t - 12 * y;
            // sum_{i=0}^{t-1} floor(i/12) = 12*(0+...+y-1) + y*rem
            const sumFloor = 12 * (y * (y - 1) / 2) + y * rem;
            return rent0 * t + rentGrowYear * sumFloor;
        }

        // лимит платежа по умолчанию
        const autoCap = rent0 + save;
        if ((+$('payCap').value || 0) <= 0) $('payCap').value = String(Math.max(0, Math.round(autoCap)));
        const payCap = +$('payCap').value || 0;

        const rMonth = apr/12;
        const maxMonths = maxYears*12;
        const horizonMonths = horizonYears*12;

        // месяц, когда впервые можно брать (накопления >= минимального взноса на тот момент)
        let tEligible = null;
        for (let t=0; t<=horizonMonths; t++){
            const st = s0 + save*t;
            if (st >= dpMinAt(t)){ tEligible = t; break; }
        }

        const scenarios = [];
        if (tEligible !== null){
            for (let t=tEligible; t<=horizonMonths; t++){
                const st = s0 + save*t;
                const priceT = priceAt(t);
                const dpMinT = priceT * dpPct;

                const cash = Math.min(st, priceT);
                const loan = Math.max(0, priceT - cash);

                const term = chooseTermMonths(loan, rMonth, maxMonths, payCap);
                const interest = interestTotal(loan, rMonth, term.months);

                const rentPaid = rentPaidUpTo(t);
                const waste = interest + rentPaid;

                scenarios.push({
                    t,
                    date: addMonths(start, t),
                    savings: st,
                    price: priceT,
                    dpMin: dpMinT,
                    cash,
                    loan,
                    termMonths: term.months,
                    payment: term.payment,
                    termOk: term.ok,
                    interest,
                    rentPaid,
                    rentNow: rentAtMonth(t),
                    waste,
                });
            }
        }

        // лучший сценарий (минимум потерь)
        let best = null;
        for (const s of scenarios){
            if (!best || s.waste < best.waste) best = s;
        }

        // сценарий "купить сразу при первой возможности"
        const first = scenarios.length ? scenarios[0] : null;

        // момент, когда "ждать дальше" становится невыгодно относительно покупки при первой возможности
        let breakEven = null;
        if (first){
            for (const s of scenarios){
                if (s.waste - first.waste >= 0){ breakEven = s; break; }
            }
        }

        // KPI
        const kpi = [];
        if (tEligible === null){
            kpi.push({t:'Ипотека возможна', v:'—', cls:'no'});
            kpi.push({t:'Статус', v:'накопления не достигают минимального взноса на горизонте', cls:'warn'});
        } else {
            kpi.push({t:'Ипотека возможна', v:`через ${tEligible} мес · ${fmtMonth(addMonths(start,tEligible))}`, cls:'ok'});
            kpi.push({t:'Мин. взнос (в момент возможности)', v:fmtMoney(dpMinAt(tEligible)), cls:''});
            kpi.push({t:'Цена квартиры (в момент возможности)', v:fmtMoney(priceAt(tEligible)), cls:''});
            kpi.push({t:'Аренда в момент возможности', v:fmtMoney(rentAtMonth(tEligible)), cls:''});
        }

        if (best){
            const deltaM = best.t - tEligible;
            const more = deltaM>0 ? `(+${deltaM} мес ожидания)` : '(сразу)';
            const termTxt = best.termMonths ? `${(best.termMonths/12).toFixed(1)} лет` : '0 (без кредита)';
            kpi.push({t:'Выгоднее купить', v:`${fmtMonth(best.date)} ${more}`, cls:'ok'});
            kpi.push({t:'Срок ипотеки (выбран)', v:`${termTxt}${best.termOk?'':' (платёж выше лимита)'}`, cls:best.termOk?'':'warn'});
            kpi.push({t:'Потери (лучший сценарий)', v:fmtMoney(best.waste), cls:''});
        } else {
            kpi.push({t:'Выгоднее купить', v:'—', cls:'no'});
        }

        if (breakEven && first){
            kpi.push({t:'Съём становится невыгоден', v:`${fmtMonth(breakEven.date)} (vs покупка при первой возможности)`, cls:''});
            kpi.push({t:'Потери при покупке сразу', v:fmtMoney(first.waste), cls:''});
        }

        // рендер KPI
        const kpiEl = $('kpi');
        kpiEl.innerHTML = '';
        for (const x of kpi){
            const div = document.createElement('div');
            div.className = 'k';
            div.innerHTML = `<div class="t">${x.t}</div><div class="v ${x.cls||''}">${x.v}</div>`;
            kpiEl.appendChild(div);
        }

        // таблица: первые 24 месяца после eligibility
        const tbody = $('tbl').querySelector('tbody');
        tbody.innerHTML = '';

        if (!scenarios.length){
            const tr = document.createElement('tr');
            tr.innerHTML = `<td colspan="11" class="small" style="text-align:left;padding:12px">Недостаточно данных или минимальный взнос не достижим на выбранном горизонте.</td>`;
            tbody.appendChild(tr);
            return;
        }

        const show = scenarios.slice(0, 24);

        for (const s of show){
            const tr = document.createElement('tr');
            const termTxt = s.termMonths ? `${(s.termMonths/12).toFixed(1)}y` : '—';
            const payTxt = s.termMonths ? fmtMoney(s.payment) : '0';
            const dBest = best ? (s.waste - best.waste) : 0;
            const deltaClass = dBest <= 0.00001 ? 'ok' : '';
            tr.innerHTML = `
        <td style="text-align:left">${fmtMonth(s.date)}</td>
        <td>${fmtMoney(s.savings)}</td>
        <td>${fmtMoney(s.price)}</td>
        <td>${fmtMoney(s.dpMin)}</td>
        <td>${fmtMoney(s.loan)}</td>
        <td>${termTxt}</td>
        <td class="${s.termOk?'':'warn'}">${payTxt}</td>
        <td>${fmtMoney(s.interest)}</td>
        <td>${fmtMoney(s.rentPaid)}</td>
        <td><b>${fmtMoney(s.waste)}</b></td>
        <td class="${deltaClass}">${s.waste===best.waste?'лучший':('+'+fmtMoney(dBest))}</td>
      `;
            tbody.appendChild(tr);
        }
    }

    function reset(){

        $('s0').value = '0';
        $('save').value = '2000';
        $('price').value = '250000';
        $('homeGrow').value = '1';
        $('dpPct').value = '0.3';
        $('apr').value = '4.5';
        $('maxYears').value = '25';
        $('rent').value = '1000';
        $('rentGrow').value = '100';
        $('payCap').value = '0';
        $('horizonYears').value = '40';
        const now = new Date();
        const yyyy = now.getFullYear();
        const mm = String(now.getMonth()+1).padStart(2,'0');
        const dd = String(now.getDate()).padStart(2,'0');
        $('startDate').value = `${yyyy}-${mm}-${dd}`;
        calc();
    }

    // init
    (function init(){
        const now = new Date();
        const yyyy = now.getFullYear();
        const mm = String(now.getMonth()+1).padStart(2,'0');
        const dd = String(now.getDate()).padStart(2,'0');
        $('startDate').value = `${yyyy}-${mm}-${dd}`;

        $('calcBtn').addEventListener('click', calc);
        $('resetBtn').addEventListener('click', reset);

        // пересчёт по Enter
        for (const id of ['startDate','s0','save','price','homeGrow','dpPct','apr','maxYears','rent','rentGrow','payCap','horizonYears']){
            $(id).addEventListener('keydown', (e)=>{ if (e.key==='Enter') calc(); });
        }

        // авто-обновление лимита платежа, если пользователь не трогал
        let payTouched = false;
        $('payCap').addEventListener('input', ()=>{ payTouched = true; });
        const recomputeCap = ()=>{
            if (payTouched) return;
            const rent0 = +$('rent').value || 0;
            const save = +$('save').value || 0;
            $('payCap').value = String(Math.max(0, Math.round(rent0 + save)));
        };
        $('rent').addEventListener('input', recomputeCap);
        $('save').addEventListener('input', recomputeCap);
        $('rentGrow').addEventListener('input', recomputeCap);

        reset();
    })();
</script>
</body>
</html>
